<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ lesson.name }} - Examplia</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(to right, #4facfe, #00f2fe);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: start;
      padding: 40px 20px;
    }

    .container {
      background-color: white;
      max-width: 700px;
      width: 100%;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo {
      font-size: 28px;
      font-weight: bold;
      color: #0077cc;
    }

    h2 {
      color: #0077cc;
      margin-bottom: 10px;
    }

    .section {
      margin-bottom: 30px;
    }

    .label {
      font-weight: bold;
      margin-top: 10px;
      color: #555;
    }

    .value {
      margin-left: 10px;
      color: #333;
    }

    select,
    input[type="file"],
    button {
      margin-top: 10px;
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      background-color: #0077cc;
      color: white;
      cursor: pointer;
      border: none;
      font-weight: bold;
    }

    button:hover {
      background-color: #005fa3;
    }

    .back-link,
    .teach-button {
      display: inline-block;
      margin-top: 20px;
      color: #0077cc;
      text-decoration: none;
    }

    .teach-button {
      font-weight: bold;
    }

    .back-link:hover,
    .teach-button:hover {
      text-decoration: underline;
    }

    .oa-list {
      margin-top: 10px;
    }

    .oa-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .oa-code {
      font-weight: bold;
    }

    .oa-desc {
      font-size: 14px;
      color: #555;
    }

    .current-file {
      margin-top: 10px;
      padding: 10px;
      background-color: #f0f8ff;
      border: 1px solid #cce0ff;
      border-radius: 6px;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <div class="logo">ðŸŽ“ Examplia</div>
      <h2>{{ lesson.name }}</h2>
    </div>

    <!-- Lesson Info -->
    <div class="section">
      <div class="label">Subject:</div>
      <div class="value">{{ lesson.subject }}</div>

      <div class="label">Course:</div>
      <div class="value">{{ lesson.course }}</div>

      <div class="label">Description:</div>
      <div class="value">{{ lesson.description }}</div>

      <div class="label">Context:</div>
      <div class="value">{{ lesson.context }}</div>
    </div>

    <!-- Assigned OAs -->
    <div class="section">
      <h3>Assigned Learning Objectives (OAs)</h3>
      <div id="oaList" class="oa-list"></div>
    </div>

    <!-- Add New OA -->
    <div class="section">
      <h3>Add New OA</h3>
      <form id="assignOaForm">
        <label class="label" for="oaSelect">Select an OA:</label>
        <select id="oaSelect" required>
          <option value="">-- Select an OA --</option>
        </select>
        <button type="submit">Assign OA</button>
      </form>
    </div>

    <!-- Upload File -->
    <div class="section">
      <h3>Upload Slide File</h3>

      <!-- Show current file -->
      <div id="fileInfo" class="current-file">Loading file info...</div>

      <!-- Upload Form -->
      <form id="uploadFileForm">
        <label class="label" for="fileInput">Choose a file:</label>
        <input type="file" id="fileInput" required />
        <button type="submit">Upload File</button>
      </form>
    </div>

    <!-- Start Teaching Button -->
    <div class="section">
      <a href="/frontend/lesson/{{ lesson.id }}/teach" class="teach-button">ðŸš€ Start Teaching</a>
    </div>

    <a href="/frontend/home" class="back-link">&larr; Back to Lessons</a>
  </div>

  <script>
    const lessonId = "{{ lesson.id }}";
    const oaListContainer = document.getElementById("oaList");
    const fileInfoContainer = document.getElementById("fileInfo");

    // Load assigned OAs
    async function loadAssignedOAs() {
      try {
        const res = await fetch(`/lessons/${lessonId}/oas`);
        const oas = await res.json();

        oaListContainer.innerHTML = "";

        if (!oas.length) {
          oaListContainer.innerHTML = "<p>No OAs assigned yet.</p>";
          return;
        }

        oas.forEach(oa => {
          const div = document.createElement("div");
          div.className = "oa-item";

          div.innerHTML = `
            <div>
              <div class="oa-code">${oa.codigo}</div>
              <div class="oa-desc">${oa.description}</div>
            </div>
            <button onclick='removeOA("${oa.id}")'>Remove</button>
          `;

          oaListContainer.appendChild(div);
        });
      } catch (err) {
        console.error("Error loading OAs:", err);
        oaListContainer.innerHTML = "<p>Error loading OAs.</p>";
      }
    }

    // Load available OAs into dropdown
    async function loadAvailableOAs() {
      try {
        const res = await fetch("/lessons/json/oas");
        const allOAs = await res.json();
        const oaSelect = document.getElementById("oaSelect");

        oaSelect.innerHTML = '<option value="">-- Select an OA --</option>';

        allOAs.forEach(oa => {
          const option = document.createElement("option");
          option.value = oa.id;
          option.textContent = `${oa.codigo} - ${oa.description}`;
          oaSelect.appendChild(option);
        });
      } catch (err) {
        console.error("Error fetching OAs:", err);
      }
    }

    // Assign OA
    document.getElementById("assignOaForm").onsubmit = async (e) => {
      e.preventDefault();
      const selectedOaId = document.getElementById("oaSelect").value;

      if (!selectedOaId) {
        alert("Please select an OA.");
        return;
      }

      console.log("Assigning OA ID:", selectedOaId);

      // Replace with real endpoint when ready
      await fetch("/lessons/oas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lesson_id: lessonId, oa_id: selectedOaId })
      });

      alert("OA assigned successfully!");
      loadAssignedOAs();
      document.getElementById("oaSelect").value = "";
    };

    // Remove OA
    window.removeOA = async (oaId) => {
      if (!confirm("Are you sure you want to remove this OA?")) return;

      console.log("Removing OA ID:", oaId);

      // Uncomment when DELETE endpoint is ready
      await fetch("/lessons/oas", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lesson_id: lessonId, oa_id: oaId })
      });

      alert("OA removed successfully!");
      loadAssignedOAs();
    };

    // Get current file info
    async function getCurrentFile() {
      try {
        const res = await fetch(`/lessons/${lessonId}/slide`);

        if (res.status === 404) {
          fileInfoContainer.textContent = "No file uploaded.";
          return null;
        }

        if (!res.ok) throw new Error("Server error");

        const data = await res.json();
        console.log("Current file data:", data);
        const filePath = data.file_path || "";
        const fileName = filePath.split("/").pop() || "Uploaded file";

        fileInfoContainer.innerHTML = `Current File: <strong>${fileName}</strong>`;
        return filePath;
      } catch (err) {
        console.warn("Error getting current file:", err);
        fileInfoContainer.textContent = "No file uploaded.";
        return null;
      }
    }

    // Upload File
    document.getElementById("uploadFileForm").onsubmit = async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];

      if (!file) {
        alert("Please select a file.");
        return;
      }

      try {
        // Step 1: Try deleting existing file
        const deleteRes = await fetch(`/lessons/${lessonId}/slide`, {
          method: "DELETE"
        });

        if (deleteRes.ok) {
          console.log("Old file deleted");
        } else if (deleteRes.status !== 404) {
          const errData = await deleteRes.json();
          throw new Error(errData.detail || "Failed to delete old file");
        }

        // Step 2: Upload new file
        const formData = new FormData();
        formData.append("file", file);

        const uploadRes = await fetch(`/lessons/${lessonId}/upload-slide`, {
          method: "POST",
          body: formData
        });

        if (!uploadRes.ok) {
          const errData = await uploadRes.json();
          throw new Error(errData.detail || "Upload failed");
        }

        const result = await uploadRes.json();
        const fileName = result.filename ? result.filename : file.name;
        fileInfoContainer.innerHTML = `Current File: <strong>${fileName}</strong>`;
        alert("New file uploaded successfully!");

        fileInput.value = "";
      } catch (err) {
        console.error("Error uploading file:", err);
        alert("Error uploading file: " + err.message);
      }
    };

    // Initial load
    window.onload = async () => {
      loadAssignedOAs();
      loadAvailableOAs();
      await getCurrentFile();
    };
  </script>

</body>
</html>