<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ lesson.name }} - Examplia</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(to right, #4facfe, #00f2fe);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: start;
      padding: 40px 20px;
    }

    .container {
      background-color: white;
      max-width: 700px;
      width: 100%;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo {
      font-size: 28px;
      font-weight: bold;
      color: #0077cc;
    }

    h2 {
      color: #0077cc;
      margin-bottom: 10px;
    }

    .section {
      margin-bottom: 30px;
    }

    .label {
      font-weight: bold;
      margin-top: 10px;
      color: #555;
    }

    .value {
      margin-left: 10px;
      color: #333;
    }

    select, input[type="file"], button {
      margin-top: 10px;
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      background-color: #0077cc;
      color: white;
      cursor: pointer;
      border: none;
      font-weight: bold;
    }

    button:hover {
      background-color: #005fa3;
    }

    .back-link {
      display: inline-block;
      margin-top: 20px;
      color: #0077cc;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .oa-list {
      margin-top: 10px;
    }

    .oa-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .oa-code {
      font-weight: bold;
    }

    .oa-desc {
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <div class="logo">ðŸŽ“ Examplia</div>
      <h2>{{ lesson.name }}</h2>
    </div>

    <!-- Lesson Info -->
    <div class="section">
      <div class="label">Subject:</div>
      <div class="value">{{ lesson.subject }}</div>

      <div class="label">Course:</div>
      <div class="value">{{ lesson.course }}</div>

      <div class="label">Description:</div>
      <div class="value">{{ lesson.description }}</div>

      <div class="label">Context:</div>
      <div class="value">{{ lesson.context }}</div>

      {% if lesson.file_path %}
      <div class="label">File:</div>
      <div class="value"><a href="{{ lesson.file_path }}" target="_blank">Download File</a></div>
      {% else %}
      <div class="label">File:</div>
      <div class="value">No file uploaded</div>
      {% endif %}
    </div>

    <!-- Assigned OAs -->
    <div class="section">
      <h3>Assigned Learning Objectives (OAs)</h3>
      <div id="oaList" class="oa-list">
        <!-- Assigned OAs will appear here -->
      </div>
    </div>

    <!-- Add New OA -->
    <div class="section">
      <h3>Add New OA</h3>
      <form id="assignOaForm">
        <label class="label" for="oaSelect">Select an OA:</label>
        <select id="oaSelect" required>
          <option value="">-- Select an OA --</option>
        </select>
        <button type="submit">Assign OA</button>
      </form>
    </div>

    <!-- Upload File -->
    <div class="section">
      <h3>Upload File</h3>
      <form id="uploadFileForm">
        <label class="label" for="fileInput">Choose a file:</label>
        <input type="file" id="fileInput" required />
        <button type="submit">Upload File</button>
      </form>
    </div>

    <a href="/frontend/home" class="back-link">&larr; Back to Lessons</a>
  </div>

  <script>
    const lessonId = "{{ lesson.id }}";
    const oaListContainer = document.getElementById("oaList");

    // Load assigned OAs for this lesson
    async function loadAssignedOAs() {
      try {
        const res = await fetch(`/lessons/${lessonId}/oas`);
        const oas = await res.json();
        console.log("Assigned OAs:", oas);
        oaListContainer.innerHTML = "";

        if (!oas.length) {
          oaListContainer.innerHTML = "<p>No OAs assigned yet.</p>";
          return;
        }

        oas.forEach(oa => {
          const div = document.createElement("div");
          div.className = "oa-item";

          div.innerHTML = `
            <div>
              <div class="oa-code">${oa.codigo}</div>
              <div class="oa-desc">${oa.description}</div>
            </div>
            <button onclick='removeOA("${oa.id}")'>Remove</button>
          `;

          oaListContainer.appendChild(div);
        });
      } catch (err) {
        console.error("Error loading OAs:", err);
        oaListContainer.innerHTML = "<p>Error loading OAs.</p>";
      }
    }

    // Load all available OAs into dropdown
    async function loadAvailableOAs() {
      try {
        const res = await fetch("/lessons/json/oas");
        const allOAs = await res.json();
        console.log("Available OAs:", allOAs);
        const oaSelect = document.getElementById("oaSelect");

        oaSelect.innerHTML = '<option value="">-- Select an OA --</option>';

        allOAs.forEach(oa => {
          const option = document.createElement("option");
          option.value = oa.id;
          option.textContent = `${oa.codigo} - ${oa.description}`;
          oaSelect.appendChild(option);
        });
      } catch (err) {
        console.error("Error fetching OAs:", err);
      }
    }

    // Assign OA
    document.getElementById("assignOaForm").onsubmit = async (e) => {
      e.preventDefault();
      const selectedOaId = document.getElementById("oaSelect").value;

      if (!selectedOaId) {
        alert("Please select an OA.");
        return;
      }

      console.log("Assigning OA ID:", selectedOaId);

      // TODO: Replace with real endpoint
       await fetch("/lessons/oas", {
         method: "POST",
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify({ lesson_id: lessonId, oa_id: selectedOaId })
       });

      alert("OA assigned successfully!");
      loadAssignedOAs(); // Refresh list
      document.getElementById("oaSelect").value = "";
    };

    // Remove OA
    window.removeOA = async (oaId) => {
      if (!confirm("Are you sure you want to remove this OA?")) return;

      console.log("Removing OA ID:", oaId);

      // TODO: Uncomment when DELETE endpoint is ready
       await fetch("/lessons/oas", {
         method: "DELETE",
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify({ lesson_id: lessonId, oa_id: oaId })
       });

      alert("OA removed successfully!");
      loadAssignedOAs(); // Refresh list
    };

    // Upload File
    document.getElementById("uploadFileForm").onsubmit = async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];

      if (!file) {
        alert("Please select a file.");
        return;
      }

      console.log("Uploading file:", file.name);

      // TODO: Replace with real endpoint
      // const formData = new FormData();
      // formData.append("file", file);
      // await fetch(`/lessons/${lessonId}/upload`, {
      //   method: "POST",
      //   body: formData
      // });

      alert("File uploaded successfully!");
      fileInput.value = "";
    };

    // Initial load
    window.onload = () => {
      loadAssignedOAs();
      loadAvailableOAs();
    };
  </script>

</body>
</html>